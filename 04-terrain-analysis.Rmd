```{r echo=FALSE}
yml_content <- yaml::read_yaml("chapterauthors.yml")
author <- yml_content[["lab3shortname"]][["author"]]
```
# Terrain Analysis {#terrain}

Written by
```{r results='asis', echo=FALSE}
cat(author)
```

## Lab Overview {-}

A Digital Elevation Model (DEM) is a digital representation of the Earth's terrain including mountains, valleys, rivers, and other topographic features. They are typically created using remote sensing technology, such as radar or LiDAR (Light Detection and Ranging), which capture elevation data points across the landscape. Typically, these elevation data points are organized into raster format, where each raster cell represents elevation within specific pixel. DEMs are used in a range of applications, including cartography, hydrology, geology, environmental analysis, and simulating water flow and erosion. 

In this lab you will use a DEM and the Hydrology toolset in ArcGIS Pro to map stream networks and watersheds within critical salmon spawning habitat in Nahmint, BC. You will then use data from Climate NA to understand how changes in temperature and precipitation may impact future water flow in these watersheds. 

``` {r, echo=FALSE, fig.align = 'center'}
knitr::include_graphics('images/04/04-terrain.jpg')
```

------------------------------------------------------------------------

### Learning Objectives {-}

- Understand how data is represented in a DEM 

- Learn how to derive slope, aspect and Topograhic Position Index (TPI) using raster focal calculations

- Use the Hydrology Toolbox to map stream networks and watershed boundaries

------------------------------------------------------------------------

### Deliverables {-}

------------------------------------------------------------------------

### Data {-}

- DEM of the Nahmint watershed region, BC

------------------------------------------------------------------------

## Task 1: Understanding DEMs {-}

**Step 1:** Create a new ArcGIS Project name it Lab4 and save it to the default directory. Import the **Nahmint_DTM.tif** and examine the Source information (right-click on the layer in the Catalog pane). 

``` {r, echo=FALSE, fig.align = 'center'}
knitr::include_graphics('images/04/04-nahmint.jpg')
```

##### Q1: What is the Projected Coordinate System and spatial resolution of the data? {.unnumbered}

##### Q2: What is the Pixel Type and Pixel Depth? How many possible values can be represented by this data? (Report answer as an exponent.) {.unnumbered}

##### Q3: What is the difference between a signed and unsigned integer? Which would represent elevation best and why? {.unnumbered}

**Step 2:** First, we will use the **Fill** tool to remove any sinks from the DEM. Sinks are small imperfections in the DEM that create areas where water cannot flow out of. The image below shows the side profile of sink and how its gets filled by the Fill tool. If sinks are not eliminated, water flow can get trapped within these depressions, leading to unrealistic pooling of water and incorrect delineation of watershed boundaries. 

``` {r, echo=FALSE, fig.align = 'center'}
knitr::include_graphics('images/04/04-sink.jpg')
```
Navigate to Analysis > Tools > Fill (Spatial Analyst). 

- Input Surface Raster: Nahmint_DTM.tiff
- Output Surface Raster: Nahmint_fill
- Z limit: leave blank

Save the output to the default file path (in your ArcMap project). 

The Z-limit represents the minimum depth of sinks that will be filled. For example, if it is set to 10m then only sinks deeper than 10m will be filled. For now leave this field blank, this will fill all sinks in the data. 

##### Q4: Why might you want to set a specific z-value? {.unnumbered} 

------------------------------------------------------------------------

## Task 2: Identifying Stream Networks {-}

**Step 1:** Next we will use the **Flow Direction** tool to to calculate the direction of water flow across the landscape. 

There are three flow modelling algorithms, but we will use the simplest: **D8**. In this model water will flow from one cell its **steepest downslope neighbour**. The cell will then be assigned a value based on which of its 8 neightbours water will flow into.

##### Q5: The following raster shows elevation above sea level. What is the flow direction from the centre cell?  Report your answer in terms of cardinal direction (North, South, Northwest etc) {.unnumbered}

``` {r, echo=FALSE, fig.align = 'center', out.width = "40%"}
knitr::include_graphics("images/04/04-flowDirJPG.JPG")
```

Use the ArcGis help page to answer to following question: https://pro.arcgis.com/en/pro-app/latest/tool-reference/spatial-analyst/flow-direction.htm

##### Q6: If a cell is assigned a Flow Direction value of 32, what cardinal direction is water flowing out of the cell? {.unnumbered} 

Navigate to Tools > Search **Flow Direction**

- Input surface raster: **Nahmint_fill**
- Output flow direction raster: **Nahmint_FlowDir**
- Flow Direction Type: D8
- Leave the rest blank/unchecked

Click Run. You should now have something like the following:

##### Q7: For the areas marked A and B, approximately what direction is water flowing? {.unnumbered} 

``` {r, echo=FALSE, fig.align = 'center'}
knitr::include_graphics("images/04/04-flowDir2.JPG")
```

**Step 2:** We will use the flow direction raster calculated in the last step to calculate **flow accumulation**, which counts the total number of cells that will flow into each cell. For example, a cell located at the bottom of the hill will have high flow accumulation and a cell at the top of a hill will not have any flow accumulation. 

Navigate to Analysis > Tools > Flow Accumulation 

- Input flow direction raster: **Nahmint_FlowDir**
- Output flow accumulation raster: **Nahmint_FlowAcc**

Leave all other fields blank. > Run.

**Step 4:** Next, we will create a raster based stream network using a threshold in the flow accumulation raster. For example, if the threshold is 100, then only cells with flow accumulation greater than 100 will be counted as a stream. Cells with flow accumulation less than 100 will be set to a background value of 0. 

##### Q8: How would your stream network change if you changed the threshold from 100 to 1000? Would there be more or less streams? Which kinds of streams would be retained using a higher threshold? {.unnumbered} 

**Step 5:** Finally, we will use the **Stream to Feature** tool to create polyline features representing our stream network. THis tool uses the stream network and the flow direction layers. See this ArcGIS help page for more information: https://pro.arcgis.com/en/pro-app/latest/tool-reference/spatial-analyst/stream-to-feature.htm

Navigate to Analysis > Tools > Stream to Feature

- Input stream raster: **Nahmint_Streams**
- Input flow direction raster: **Nahmint_FlowDir**
- Output polyline features: **Nahmint_StreamNetwork**
- Simplify polylines: Checked

##### Q9: Compare your stream network to the streams in the ArcGIS basemaps (satellite, or topographic). Does it seem like your stream network identified all the streams in the area? Are there any missing streams or weird results? {.unnumbered} 

------------------------------------------------------------------------

## Task 3: Mapping Watersheds {-}

A watershed is an area of land where all the water that falls or flows into it converges to a common outlet, such as a river, lake, or ocean. It is defined by the topographic or drainage divide, which separates the water flowing into different basins. In this task we will delineate the boundaries of the Nahmint watershed. 

The watershed tool uses flow direction and user defined **pour points** to delineate watershed boundaries. The watershed boundaries will be defined such that water flows into the defined pour points. This is useful for determining the area of land that contributes water to a specific stream or lake.  

**Step 1:** First, we will create a new shapefile for our pour points. Navigate to the Catalog Pane and locate the default project directory. Right-click on the default geodatabase > New Layer. 

Edit the layer > Create Features

Click on the map where you want to define pour points. Use the stream network to define pour points at the intersection of stream segments (see example below). You should have approximately 6 pour points. 

If you want to delete a point, open the Attribute table, select the pour point you want to remove (either by clickon on it in the attribute table or using the select tool on the top ribbon) and click delete. You can also move existing points by selecting them and dragging them to new locations

**Step 2:** Navigate to Analysis > Tools > Watershed

- Input D8 flow direction raster: **Nahmint_FlowDir**
- Input raster or feature pour point data: **PourPoints.shp**
- Output raster: **Nahmint_watersheds**

The output will be a raster where the cell values correspond to the different watershed catchment areas. 

**Step 3:** Next, we will convert the raster based watersheds into polygon features. 

Analysis > Tools > **Raster to Polygon** (you may remember this tool from Lab 3). 

Set the input raster to the watersheds raster, name the features **Watershed_polys** and save to the default GDB. Make sure the **Simplify Polygons** box is checked. 

##### Q10: What is the area of the largest watershed? Report answer in km2 and round to two decimal places. {.unnumbered} 

**Step 4:** Create a map and include it in the final deliverables. The map must have the following elements: 

- Stream network polylines
- Watershed polygons - assign different colors to each polygon
- Title
- North arrow
- Scale bar
- Legend
